#!/usr/bin/env bash

set -e

source $HOME/.zsh/exports.sh
source $HOME/.zsh/asdf.sh

lockfile=$(dirname $0)/../LOCK

if [[ -f "$lockfile" ]]; then
  terminal-notifier \
    -message "Skipping script; repository is locked." \
    -ignoreDnD \
    -title "email_data" \
    -group homebrew \
    &> /dev/null
  exit 1
fi

git reset --hard
git checkout main
git pull --rebase
git push

./bin/sync

git_status=$(git status 2> /dev/null | tr "\\n" " ")

if [[ "$git_status" =~ "nothing to commit" ]]; then
  terminal-notifier \
    -message "No changes detected. Skipping new packages." \
    -ignoreDnD \
    -title "email_data" \
    -group homebrew \
    &> /dev/null
  exit 1
fi

date "+%s" > VERSION

version=$(cat VERSION)
package_json=$(cat package.json | jq --arg version "${version}.0.0" '.version = $version')

echo $package_json | jq --tab > package.json

asdf local ruby 2.7.2

gem install bundler
bundle update

git add .
git commit -m "Bump up version."
git push

./bin/publish-gem
./bin/publish-npm
