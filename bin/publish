#!/usr/bin/env bash

set -e

source $HOME/.zsh/exports.sh
source $HOME/.zsh/asdf.sh

git pull --rebase
git push

./bin/sync

git_status=$(git status 2> /dev/null | tr "\\n" " ")

if [[ "$git_status" =~ "nothing to commit" ]]; then
  terminal-notifier \
    -message "No changes detected. Skipping new packages." \
    -ignoreDnD \
    -title "email_data" \
    -group homebrew \
    &> /dev/null
  exit
fi

date "+%s" > VERSION

version=$(cat VERSION)
package_json=$(cat package.json | jq --arg version "${version}.0.0" '.version = $version')

echo $package_json | jq --tab > package.json

git add .
git commit -m "Bump up version."
git push

./bin/publish-gem
./bin/publish-npm
